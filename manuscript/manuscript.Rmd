---
title: "Index measures for oak decline severity using phenotypic descriptors"
output: 
  #bookdown::word_document2:
  # toc: false
  bookdown::pdf_document2: 
    toc: false
    number_sections: false
bibliography: references.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE)
```

```{r loadData, include = FALSE}
loadd(site_rf_margin,
      site_rf_post_correction_margin,
      PDI_status_ttest,
      DAI_groups_ttest,
      PDI_rf_tune_params,
      DAI_rf_tune_params,
      analysis_suitable_data,
      site_corrected_analysis_suitable_data,
      remission_PDI_group_ttest,
      remission_DAI_group_ttest)
```

**Authors:** Jasen Finch, Nathan Brown, Sandra Denman & John Draper

**Proposed journal:** Still undecided! ??Plant Methods, Forestry?? 

**Keywords:** acute oak decline, chronic oak decline, phenotyping, machine learning, unsupervised learning, random forest

## Abstract

Two indexes, the Phenotypic Decline Index (PDI) and the Decline Acuteness Index (DAI), were developed to describe acute and chronic oak decline severity using a multitude of easily measurable phenotypic descriptors.
Measured phenotypic descriptors include aspects of tree shape and size, crown condition and the presence of biotic agents.
These were collected from 174 trees exhibiting a spectrum of decline severity at 9 sites from across the south, east and west of England.
Inter site differences were identified as a results of aspects of tree size which were corrected for using a mean centring adjustment.
The decline indexes were then calculated using proximity values from an unsupervised random forest of the phenotypic descriptors, multidimensional scaling (MDS) and min-max scaling.
These indexes are simple but sensitive measures of tree decline severity allowing easy comparisons of oak trees both spatially and temporally providing a useful tool for forest monitoring and management.

## Introduction

- Monitoring currently focusses on crown assessments
- Acute and chronic decline associated phenotypes
- The oak decline spectrum move away from simplistic binary categorisations
- Manual assignment of decline status difficult prone to error for due to contribution of many factors. 
- Unsupervised learning for complex patterns between descriptors.

Oak declines are complex syndromes that are facilitated by a variety of both abiotic and biotic factors.
Abiotic factors can include both predisposing and inciting factors such as drought and are often
Biotic agents can include insect infestation such as the larvae of bark boring beetle *Agrilus biguttatus* associated 

As a results of this, there are many visual phenotypic descriptors encompassing the entirety of an oak tree that contribute to what can be defined as a declining oak tree.
A severely declining oak is most prominently characterised by very poor crown condition and numerous dead branches (ref).
It is these characteristics that many studies use as the primary indicator of tree decline severity [@zarnoch2004].

Compounding this complexity is the addition of different types of oak decline (AOD) that are often categorised based on the duration over which a tree has been declining or the biotic agents/factors associated with a declining tree.
For instance a chronically declining oak can subsequently begin to also develop the stem bleeds associated with AOD [@denman2014].
Accurately diagnosing in the field the severity and type of oak decline present is difficult and can requires much experience, expertise and training.

It is becoming increasingly important that oak tree health within woodlands is accurately and sensitively monitored to enable the detection of decline as well as it's spread and severity over time to enable accurate forecasting and inform forestry management practices (ref).
Monitoring methods need to take advantage of modern data analysis techniques whilst still retaining practical simplicity in the field.

Machine learning is finding increasing utility in biological and geographical applications due to it's ability to learn complex patterns within and between variables.
A popular algorithm is that of random forest due to it's versatility, relatively trivial training requirements and resilience against over fitting [@breiman2001] (refs). 

- Random forest has previously been used in a forest condition context [@vitale2014].

It is an ensemble machine learning method where forests of bootstrap sampled decision trees are grown, yielding both out of bag sample prediction accuracies and variable importance.
It is also able to simultaneously handle both continuous and categorical variables.
Unsupervised learning is also possible [@shi2006]

Here, we propose a framework to enable quantitative visible oak decline severity measurement that utilises a range of targeted phenotypic descriptors and unsupervised random forest machine learning.
The two resulting measures are:

* The phenotypic decline index (PDI) - a measure of decline severity scoring trees between 0 and 1.
More severely declining oak trees have a score closer to 1.

* The decline acuteness index (DAI) - a measure differentiating between chronically and acutely declining oak trees with a score between -1 and 1. 
Acutely declining trees have a score closer to 1 and chronically declining trees have a score closer to -1.

## Materials and methods

### Phenotypic data collection

The phenotypic data were collected from a total of 174 trees from nine sites from across the south (Hatchlands and Richmond Park), east (Big Wood, Great Monks Wood and Winding Wood) and west (Attingham, Chestnuts, Langdale and Speculation) of England between June and September in 2016 or 2017.
The occurrence of AOD has previously been reported and studied at six of the sites [@brown2016; @brown2017].
These sites included a variety of woodland types, management types, soil types and tree sizes/ages.

Descriptors were collected relating to the trees shape, size, crown condition and the presence of biotic agents including insects, bacteria and fungi.
All trees were manually assigned a decline status category; control, AOD, COD or remission prior to collection of phenotypic descriptors.
The remission group included trees that had shown stem bleeds associatied with AOD in the past but were not showing signs of stem bleeds at the time of assessment.

Diameter at breast height (DBH) was collected at a stem height of 1.3m, to the nearest 0.1cm.
Total height, timber hight and lowest live crown were measured using an inclinometer to the nearest 0.1m
The timber height was measured at either 7cm top stem diameter or where no main stem could be distinguished.
For the crown, canopy closure, missing crown and absolute crown density percentages were visually estimated within 5% classes

Other categorical descriptors included social class, diaback type, main crown dieback location, stem epicormic growth, branch epicormic growth, extent of insect damage, insect damage type, extent of crown mildew and the presence or absence of pruning damage or branch loss from the main stem.
See supplementary table # for category details.

Crown radius, canopy closure and tap tests for dead stem tissue were measured for each cardinal point.
The crown radius was measured using a vertex transponder attached to the relevant side of the stem at a height of 1.3m.Canopy closure recorded as yes or no depending on whether any other crowns are touching the sampling tree.
A high resolution photo was taken of the vase to the spring of the crown and of the stem from the base to a height of 3m for each cardinal point for later reference.

The AOD stem symptoms (active bleeds, black staining, callused wounds) were collected by measuring longest axis of each individual bleed, stain or callused wound found within the basal 3m of the stem (ref).
The frequency of *A. biguttatus* exit holes were counted along with the presence or absence of each of oval shaped exit holes, small circular shaped exit holes and ground level fungal fruiting bodies were recorded from the basal 2m of the stem (ref). 
These descriptors are shown in Supplementary table #.

### Phenotypic descriptor preparation

R version `r str_c(version$major,version$minor,sep ='.')` was used for all parsing, preparation and subsequent analysis of phenotypic data [@R2019].
All raw data, data preparation routines and analysis code used to generate this manuscript are available at https://github.com/jasenfinch/Index_measures_for_oak_decline_severity_using_phenotypic_descriptors.

All cardinal assessments were averaged to give a single value per tree.
The crown density ($CD$) values erranously collected at Attingham and Langdale were converted to crown transparency ($t = 100 - CD$)
All descriptors collected in cm were converted to mm.
The tap tests that were positive for hollow stem tissue were converted to present and absent renamed dead stem tissue.
The canopy closure descriptor was converted from yes and now to present and absent.
Finally, the stem symptoms sizes for active bleeds, black staining and callused wounds were averaged and a frequency per tree collected.
After preparation there were a total of 31 raw descriptors for analysis. 

### Tree size descriptor adjustment for age and inter site variance

To account age, size and site specific tree difference, an adjustment of site means to the overall mean was applied to each of the size descriptors (diameter at breast height, lower crown height, timber height, total height, crown radius). 
An example of this adjustment is shown for diameter at breast height in Supplementary Figure # and the adjustment factors for each of the descriptors at each site is shown in Supplementary Table #.  

### Composite descriptor calculation

Five additional, composite descriptors were calculated to account for the three dimensional attributes of the tree and covariate nature of certain descriptors as suggested by @zarnoch2004.
This then gave a total of `r ncol(analysis_suitable_data)` raw and composite phenotypic descriptors.
The additional descriptors are defined as follows:

**Live crown ratio (%)** - percentage of the whole tree height that supports live crown.

$$R = \frac{(h-l)}{h} \times 100$$

$h$ = total height (m), $l$ = lower crown height (m)

**Crown condition (%)** - percentage of present crown proportional to the percentage crown density.

$$c = (100 - m)(1-\frac{t}{100})$$

$m$ = missing crown (%), $t$ = crown transparency (%)

**Composite crown volume (m^3^)** - Estimated volume of crown as an paraboloid proportional to the crown condition. Adapted from the composite crown volume from @zarnoch2004 using crown condition instead of crown density alone.

$$v = \frac{\pi r^2c(h-l)}{200}$$

$r$ = crown radius (m)

**Estimated bleed prevalence (%)** - estimated percentage of the surveyed 3m basal trunk area affected by bleeds or black staining.

$$p = \frac{a^2A + b^2B}{3d\pi}$$

$a$ = average active bleed size (mm), $A$ = number of active bleeds, $b$ = average black stain size (mm), $B$ = black stain number, $d$ = diameter at breast height (mm)

***Agrilus* exit hole density (m^-2^)** - density of observed *Agrilus* exit holes across the surveyed 2m basal trunk area.

$$e = \frac{h}{\frac{2d}{100}\pi}$$

$h$ = number of *Agrilus* exit holes

### Calculation of indexes for oak decline severity

The phenotypic descriptors were analysed using 100 repetitions of unsupervised random forest using the randomForest R package v`r packageVersion('randomForest') %>% as.character()` [@liaw2002].
The proximity matrices from each repetition were averaged to a single proximity matrix ($P$).
This was then transformed to a dissimilarity matrix ($1 - P$) and scaled to two dimensions using  multidimensional scaling (MDS).
The first MDS dimension ($D$) was first inverted ($1 - D$) to ensure the correct dimension orientation relative to decline severity.
It was then min-max scaled to give a scale between 0 and 1 with more severely declining trees having a score closer to 1.
This dimension was named the PDI.
The second MDS dimension was min-max scaled and then transformed ($2D - 1$) to give a scale between -1 and 1 with COD trees having a score closer to -1 and AOD having a score closer to 1. 
This dimension was named the DAI.
With different data, it is likely that the MDS dimensions may require inversion prior to min-max scaling to ensure their correct orientation.

The code used to generate the decline indexes is available as an R package pdi v`r packageVersion('pdi') %>% as.character()` at https://github.com/jasenfinch/pdi.

### Descriptor contribution to decline indexes

Individual random forest regression models of the phenotypic descriptors were trained, supervised using each decline index.
The optimal number of trees (ntree) and number randomly of variables (mtry) parameters for random forest were tuned prior to training. 
The combination parameters giving the lowest percent mean absolute error (PMAE) were selected and set as follows: PDI - `r glue('ntree = {PDI_rf_tune_params$ntree}, mtry = {PDI_rf_tune_params$mtry}, PMAE = {PDI_rf_tune_params$PMAE %>% signif(digits = 3)}%')`; DAI - `r glue('ntree = {DAI_rf_tune_params$ntree}, mtry = {DAI_rf_tune_params$mtry}, PMAE = {DAI_rf_tune_params$PMAE %>% signif(digits = 3)}%')` (Supplementary figure #)

Overall descriptor importance contributions to each of the indexes was retrieved from these models using the mean decrease in accuracy measure (ref).

### Local descriptor contribution to index models

Local Interpretable Model-Agnostic Explanations (LIME) were computed to identify descriptors contributing locally to case specific examples of each of the indexes [@ribeiro2016]. 
The lime R package v`r packageVersion('lime') %>% as.character()` was used with the default parameters [@pedersen2019].
A healthy, a moderate and a severe decline cases was used for the PDI. 
For each case, a tree with a score closest to 0, 0.5 and 1 respectively was selected.
For the DAI cases were selected from trees with a PDI score greater than 0.5, 
A decline neutral case was selected with a score closest to 0.
Then for each of the AOD and COD syndromes, moderate and severe cases were selected with scores closes to 0.5 and 1 for AOD and -0.5 and -1 for COD. 

### Index model simulations to investigate interactions of key descriptors

The interactions of key raw descriptors identified from the overall importance scores and their associations with the decline indexes was investigated by using simulated descriptor values to construct index model responses surfaces for specific cases.
This approach was similar to response surface methodology without the need for probabalistic approximation due to the low computation time required for index calculation (ref).

For the PDI, missing crown and crown transparency were compared for example cases of a healthy, a moderate and a severly tree.
The example cases included the trees with the minimum and maximum PDI values and the tree with the PDI value closest to the median for the healthy, severe and moderately declining trees respectively.
The value ranges for the missing crown (`r glue("{min(site_corrected_analysis_suitable_data[['Missing crown (%)']])}-{max(site_corrected_analysis_suitable_data[['Missing crown (%)']])}%")`) and crown transparency (`r glue("{min(site_corrected_analysis_suitable_data[['Crown transparency (%)']])}-{max(site_corrected_analysis_suitable_data[['Crown transparency (%)']])}%")`) descriptors divided into 100 increments.
For a given case, each combination of theses simulated descriptor values were used to calculate a PDI value from the supervised random forest regression model, building a model response surface.

```{r stem_symptom_ranges}
symptom_ranges <- site_corrected_analysis_suitable_data %>%
  select(`Active bleed size (mm)`,`Black staining size (mm)`) %>%
  gather(descriptor,value) %>%
  group_by(descriptor) %>%
  summarise(minimum = min(value),
             maximum = max(value),
             center = minimum + (maximum - minimum) / 2
             )
```


The same approach was used for the DAI using also a comparison between active bleed size and black staining size as well as missing crown and crown transparency.
The upper boundary for the ranges of active bleed size and black stain size was taken as the center value between the maximum and minimum and reduced by a factor of eight to give ranges of `r glue("{symptom_ranges$minimum[1]}-{signif(symptom_ranges$center[1] / 8,digits = 3)}mm")` and `r glue("{symptom_ranges$minimum[2]}-{signif(symptom_ranges$center[2] / 8,digits = 3)}mm")` respectively and enable more effective visualisation.
Cases included neutral, moderate and severe with PDI scores greater than 0.5 and DAI scores closest to 0, 0.5 and 1 respectively for AOD and 0, -0.5 and -1 respectively for COD.

## Results

### Site differences

High discrimination was found in the phenotypic descriptors between between the sites using supervised random forest classification (Supplementary  figure #a; margin = `r site_rf_margin$Margin %>% signif(digits = 3)`). 
The descriptors that contributed most to this discrimination were those that were related to trees size such as DBH, total height and crown radius and likely reflect the varied tree age and planting density acrosses the nine sites (Supplementary figure #b). 
After the trees size adjustment was applied to removed inter-site variability but maintain intra-site variability, the random forest margin was substantially reduced to `r site_rf_post_correction_margin$Margin %>% signif(digits = 3)` indicating that the majority of the between site variance had been removed.
This enabled comparisons to be made between the trees at the different sites in the context of decline severity.

### Oak decline severity indexes of manually assigned decline statuses

A scatter plot of the calculated PDI and DAI scores is shown in Figure # for all 174 trees for which phenotypic descriptor data was collected.
It can clearly be seen that the control trees group towards the lower end of the PDI scale and the sympotmatic COD and AOD groups towards the higher end.
This gave a significant difference when PDI of the control and symptomatic (AOD and COD) decline statuses were compared using an independent two sample t-test (`r glue("t({PDI_status_ttest$parameter}) = {signif(PDI_status_ttest$statistic,digits = 3) %>% abs()}, p < 0.001")`) with group means of `r signif(PDI_status_ttest$estimate1,digits = 3)` and `r signif(PDI_status_ttest$estimate2,digits = 3)` for non-symptomatic and symptomatic statuses respectively.

On the DAI scale, the AOD trees group at the upper end of the scale (> 0) and the COD trees at the lower end (< 0).
This was confirmed with significance found in the DAI between these groups (`r glue("t({DAI_groups_ttest$parameter}) = {signif(DAI_groups_ttest$statistic,digits = 3) %>% abs()}, p < 0.001")`) with group means of `r signif(DAI_groups_ttest$estimate1,digits = 3)` and `r signif(DAI_groups_ttest$estimate2,digits = 3)` for the AOD and COD groups respectively.

The remission trees were found to be significantly different in their PDI scores from both the control (`r glue("t({remission_PDI_group_ttest$parameter[1]}) = {signif(remission_PDI_group_ttest$statistic[1],digits = 3) %>% abs()}, p < 0.001")`) and symptomatic (AOD and COD; `r glue("t({remission_PDI_group_ttest$parameter[2]}) = {signif(remission_PDI_group_ttest$statistic[2],digits = 3) %>% abs()}, p < 0.001")`) groups with means of `r signif(remission_PDI_group_ttest$estimate1[1],digits = 3)`, `r signif(remission_PDI_group_ttest$estimate2[1],digits = 3)` and `r signif(remission_PDI_group_ttest$estimate2[2],digits = 3)` for the control, remission and symptomatic groups respectively.
As a group these trees are showing moderate overall decline.

The remission trees were also found to be significantly different to the AOD (`r glue("t({remission_DAI_group_ttest$parameter[1]}) = {signif(remission_DAI_group_ttest$statistic[1],digits = 3) %>% abs()}, p = < 0.001")`) and COD (`r glue("t({remission_DAI_group_ttest$parameter[2]}) = {signif(remission_DAI_group_ttest$statistic[2],digits = 3) %>% abs()}, p = {round(remission_DAI_group_ttest$p.value[2],3)}")`) groups on the DAI scale with group means of `r signif(remission_DAI_group_ttest$estimate1[1],digits = 3)`, `r signif(remission_DAI_group_ttest$estimate2[1],digits = 3)` and `r signif(remission_DAI_group_ttest$estimate1[2],digits = 3)` for the AOD, remission and COD groups respectively. 
As a group the remission trees are of neutral decline type.

### Key descriptors contributing to the decline indexes

- Top ranked descriptors contributing to the decline indexes

The top ranked descriptors found to contr crown related descriptors were found to contribute most to the PDI (Figure #a) with more severely declining trees having reduced crown volume and condition.

- Plots of the individual descriptors available  

The DAI was a more complex in descriptor contribution with trunk staining and bleeding descriptors contributing highly with bleed prevalence contributing the most. 
Trees with high bleed prevalence and therefore a larger area of their trunk covered with black staining or active bleeds had much higher DAI scores.

- Agrilus exit hole density had no contribution

### Localised descriptor contributions and trends within the PDI and DAI models

- Important descriptors identified model-wide aren't necessarily relevant to localised cases. 

- Top descriptors for each case same as top descriptors in overall model importance lists for PDI.
- Decline is associated with a reduction in the size and condition of the crown

- Different descriptors locally compared to overall importance for DAI.
- COD trees have greater crown contact than AOD trees.
- Bleed prevalence not included in any local importances
- Descriptors relevant to context

### Key descriptor interactions within the decline index models

The complex descriptor interactions within the index models can be investigated by simulating phenotypic data and generating the index values from the supervised index random forest regression models. 
The index values generated by the models from these simulated phenotypic data can then be visualised as response surface plots, from which descriptor interactions within the indexes can be interpreted. 
Figures # and # show the simulated index value response surfaces under a variety of different circumstances for key phenotypic descriptors that contribute highly to the PDI and DAI.

Crown condition descriptors such as crown volume and crown condition contributed highly to the PDI (Figure #). 
The phenotypic measures central to this were percentage missing crown and percentage crown transparency from which crown condition and crown volume are calculated. 
It can be seen in Figure # that as the percentage missing crown and percentage crown transparency increase and therefore crown condition and estimated crown volume decrease, the PDI increases. 
A much greater range of PDI values can be obtained from trees with relatively greater stature (e.g. greater crown radius, total height, lower crown height and diameter at breast height; Figures #a & b), with relatively small stature trees having PDIs of 0.5 or greater even with 100% crown condition.

The DAI is a much more complex index with more descriptors contributing to it than the PDI such as bleed prevalence, diameter at breast height and crown condition descriptors. 
Simulated response surfaces for the DAI are shown in Figure c. 
These response surfaces show circumstances under which bleed prevalence related descriptors (Figures #a, b & c) and crown condition descriptors (Figures dd, e & f) change for non-symptomatic AOD or COD trees (Figures #a & d respectively), moderate AOD or COD (Figures #b & e respectively) and severe AOD or COD (Figures #c & f respectively). 
Increasing active bleed, staining size and frequency contributed to greater positive values of the DAI and more severe AOD. 
Also higher DAI values could be obtained from trees with greater stature (Figure #c). 
Crown transparency and missing crown have no influence on the DAI for trees of neutral decline type (Figure #d).
Similarly to the PDI, trees with smaller stature and poorer crown condition give lower DAI values (Figures #e & f) and therefore more severe COD.
The relationship of relative tree stature and the acuteness of the decline likely reflects the period of time under which these trees have been afflict. 
AOD occurs over a much shorter period compared COD and therefore has less time in which to inhibit growth of the tree as a whole.

## Discussion

- reasons for selecting machine learing approach
- use of unsupervised over supervised analysis
- Semi-supervised can be used if unsupervised model is unable to pull out decline severity scale
- For given context, descriptors not contributing to the indexes could be removed

- Accessability of collecting descriptors
- Suitability of collected phenotypic descriptors for describing decline status
- Concession of model interpretability to predictive capability by using a machine learning approach
- Index thresholds for category definitions (healthy, declining, severe decline etc.)
- Scalability of method for wider application
- Thresholds for decline groupings within index ranges
- Validation of decline scores - chicken and paradox

This plot highlights the inaccuracies in manual field classifications of decline status with several trees classified as healthy controls that, when compared quantitatively to other trees, are in fact
in a decline state. 
Most notably this has occurred in a number of trees at Attingham, Hatchlands and Winding Wood. 
Also notable from Figure 3 is the disparity between the relative health of the healthier trees across the sites. 
The healthier trees at sites such as Attingham and Hatchlands were found to be in a more declined state than those at sites such as Langdale and Chestnuts.

A machine learning approach was used to derive these measures as it allows the complex interactions and trends between phenotypic descriptors to be modelled from which the decline indexes are calculated. 
This would likely be oversimplified using conventional modelling strategies. 

The two dimensional space provided by these phenotypic indexes, for measuring decline severity is shown in Figure 1. 
The phenotypic descriptors used to calculate these indexes are easily measurable in the field and require no specialist equipment. 
They allow sensitive comparisons to be made for the same tree between years as well as comparisons of trees between different locations, which could have great utility in long term forest health monitoring for both forestry management and research.

### Applications

- Discussion of applications to forestry monitoring and management
- Sensitivity for integration with molecular data compared to categorical assignments
- Sensitivity provided for integration with large scale omics analyses as well as long term monitoring for forest condition
- Refined definition of remission - repeat measurement

## Conclusions

- Crown condition descriptors most important for describing overall decline severity in the PDI.
- Bacterial bleed related descriptors are most important for describing decline acuteness.
- Decline indexes provide intuitive measures of decline severity based on simple phenotypic measurements that do not require specialist equipment
- Encouraged to use this approach in other contexts

\newpage
## Checks

```{r check,comment='',cache=FALSE}
manuscript_check(checks = c('word count','spelling'))
```

## References